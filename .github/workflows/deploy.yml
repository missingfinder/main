name: Deploy Cloudflare Workers

on:
  push:
    branches:
      - main

jobs:
  deploy-cloudflare-workers:
    name: Deploy Cloudflare Workers
    runs-on: ubuntu-latest

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      WORKER_SECRET_PASSWORD: ${{ secrets.WORKER_SECRET_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Wrangler CLI
        run: npm install -g wrangler@latest

      - name: Debug GitHub Secrets
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "âŒ CLOUDFLARE_API_TOKEN is missing!"
            exit 1
          else
            echo "âœ… CLOUDFLARE_API_TOKEN is set."
          fi

      - name: Deploy Workers
        run: |
          for i in $(seq 1 2); do
            WORKER_NAME="geo-missing-lookup$i"
            echo "ğŸš€ Deploying $WORKER_NAME"
            
            # wrangler.toml íŒŒì¼ì„ ì„ì‹œ ìˆ˜ì •í•˜ì—¬ Worker ì´ë¦„ ë³€ê²½
            sed -i "s/^name = .*/name = \"$WORKER_NAME\"/" src/geo-missing-lookup/wrangler.toml
            
            # Worker ë°°í¬ (í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©)
            wrangler deploy --config src/geo-missing-lookup/wrangler.toml
            
            # ì›ë˜ëŒ€ë¡œ ë³µêµ¬
            git checkout -- src/geo-missing-lookup/wrangler.toml

            # API Rate Limit ë°©ì§€ (1ì´ˆ ëŒ€ê¸°)
            sleep 1
          done
